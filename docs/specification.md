# ttt(Tiny Task Tool) - 仕様書

Updated: 2026-01-18

## この文書について

この文書は ttt (Tiny Task Tool) の機能仕様を定義します。

- 構想・設計思想については [concept.md](concept.md) を参照
- 技術選定・アーキテクチャについては [architecture.md](architecture.md) を参照

## プロジェクト名

**ttt** (Tiny Task Tool)

- 短く覚えやすいです。
- 目的が明確です。
- コマンドとして打ちやすいです。

```bash
ttt                                    # TUIを起動
ttt -t buy kitchen paper and wasabi    # タスクを追加（TUIは起動しない）
ttt --task "buy kitchen paper"         # 引用符付きも可
ttt --help                             # ヘルプ表示
ttt -h                                 # ヘルプ表示
ttt --version                          # バージョン表示
ttt -v                                 # バージョン表示
```

ファイルの指定は行いません。「一枚の紙」の原則に基づき、開くファイルは設定ファイルで指定された固定の1ファイルのみです。

`-t`（`--task`）オプションでタスクを追加できます。引数がある場合はタスクとしてメインファイルに追記し、TUIは起動しません。ターミナルから離れずにサッとタスクを追記できます。

## ユースケース

### 典型的な一日の流れ

#### 1. 朝のルーティン

```bash
ttt
```

- 昨日の残タスクを確認します。
- `archive.auto = true` なら、設定日数経過した完了タスクが自動アーカイブされます。
- `a`キーでいつでも手動アーカイブを実行できます。
- `e`でエディタを開き、今日のタスクを書き足します。
- エディタを閉じてtttに戻ります。
- tttに戻ると、完了したタスクには @done(日付)が自動追加されます。
- `q`で終了します。

#### 2. 作業中

```bash
ttt
```

- タスクを眺めて次の行動を決めます。
- タスクが終わったら`e`でエディタを開いてチェックします。
- 思いついたことを書き足します。

#### 3. 一日の終わり

```bash
ttt
```

- 今日完了したことを確認します。
- `e`でエディタを開き、完了したタスクを`- [ ]`から`- [x]`に変更します。

## TaskPaper形式の採用

### 完了日の記録

タスク完了時に、TaskPaper形式で日付を記録します。

```markdown
- [ ] 未完了タスク
- [x] 完了タスク @done(2026-01-18)
- [x] 古い完了タスク @done(2026-01-10)
```

### アーカイブのタイミング

アーカイブの実行タイミング（詳細は「設定ファイル仕様」セクションを参照）：

- **`a`キー**: いつでも手動でアーカイブを実行可能
- **起動時自動実行**: `archive.auto = true` の場合、起動時に自動実行

アーカイブ対象は `delay_days` で指定した日数が経過した完了タスクのみです。これにより、完了したタスクをしばらく見える場所に残せます。

### アーカイブの仕組み

完了したタスクはアーカイブファイル（`archive.md`）に移動します。メインファイルからは削除されるため、起動直後の画面に表示されなくなります。

**アーカイブファイルの構成**

完了日ごとに `## YYYY-MM-DD` のセクションを作成し、その日付に完了したタスクをまとめます。

```markdown
## 2026-01-20

- [x] タスクA @done(2026-01-20)
- [x] タスクB @done(2026-01-20)

## 2026-01-19

- [x] タスクC @done(2026-01-19)
```

**特徴**

- メインの`ttt`で開くファイルには完了日から一定期間経過したタスクは表示されない
- 履歴が必要な場合は`archive.md`を別途確認可能
- プレーンテキストなので、どのツールでも読める
- Gitで完全な履歴を管理できる

## 設定ファイル仕様

### 配置場所

```
~/.config/ttt/config.toml
```

XDG Base Directory仕様に準拠した標準的な場所に配置します。

### 設定ファイルの構成

```toml
[file]
# タスクファイルを配置するディレクトリ
working_dir = "~/.ttt"
# ファイル名は固定:
#   - tasks.md (メインファイル)
#   - archive.md (アーカイブファイル)

[archive]
# 起動時に自動アーカイブを実行するか
auto = false
# 完了から何日後にアーカイブ対象とするか
delay_days = 2

[editor]
# エディタ起動コマンドテンプレート
# {file} はファイルパスに置換される
# 省略時は環境変数 $EDITOR を使用（"{file}" を末尾に自動付加）
# 例: command = "vim {file}"
# 例: command = "code --wait {file}"
# 例: command = "emacs -nw {file}"
command = "vim {file}"

[keybindings]
# ↑↓キーの代替キー（複数指定可能）
up = ["k", "ctrl+p"]
down = ["j", "ctrl+n"]

# 先頭/末尾移動
top = ["g", "Home"]
bottom = ["G", "End"]

# 半画面スクロール
half_page_up = ["ctrl+u"]
half_page_down = ["ctrl+d"]

# 修飾キーの記法:
#   - ctrl+<key>: Ctrlキー + キー (例: ctrl+n, ctrl+p)
#   - alt+<key>: Altキー + キー (例: alt+f, alt+b)
#   - shift+<key>: Shiftキー + キー (例: shift+tab)
#   - 大文字小文字は区別する（G ≠ g）
#   - 機能キー: Home, End, PageUp, PageDown など

[git]
# 自動コミット（デフォルト有効）
# 変更時にバックグラウンドで自動的にgitコミット
auto_commit = true
```

### デフォルト値

設定ファイルが存在しない場合、以下のデフォルト値が使用されます：

- `file.working_dir` → `~/.ttt`
- ファイル名（固定）:
  - メインファイル: `tasks.md`
  - アーカイブファイル: `archive.md`
- `archive.auto` → `false`
- `archive.delay_days` → `2`
- `editor.command` → 環境変数 `$EDITOR` の値 + ` {file}`
  - `$EDITOR` 未設定の場合: `vi {file}`
- `keybindings.up` → `["k"]`
- `keybindings.down` → `["j"]`
- `keybindings.top` → `["g", "Home"]`
- `keybindings.bottom` → `["G", "End"]`
- `keybindings.half_page_up` → `["ctrl+u"]`
- `keybindings.half_page_down` → `["ctrl+d"]`
- `git.auto_commit` → `true`

### 設計上の理由

- **ファイル名固定**: 「一枚の紙」の原則を強化し、ファイル選択の複雑さを排除
- **テンプレート形式**: エディタ固有のオプション（`--wait`, `-nw` など）を柔軟に指定可能
- **XDG準拠**: Linux/macOSの標準的な設定ファイル配置に従う

## キーバインド仕様

tttはビューア型のTUIツールであり、編集機能は持ちません。シンプルで覚えやすいキーバインドを提供します。

### 固定キーバインド（設定変更不可）

以下のキーは固定されており、設定ファイルで変更できません：

| キー | 動作 | 説明 |
|------|------|------|
| `↑` | 1行上へスクロール | 常に有効 |
| `↓` | 1行下へスクロール | 常に有効 |
| `e` | エディタ起動 | 設定されたエディタでtasks.mdを開く |
| `a` | アーカイブ実行 | 条件を満たす完了済みタスクをアーカイブ |
| `r` | 再読み込み | ファイルを再読み込み（エディタ終了後は自動） |
| `q` | 終了 | tttを終了 |
| `?` / `h` | ヘルプ表示 | キーバインド一覧をオーバーレイ表示 |

### 設定可能なキーバインド

以下のキーは設定ファイル (`[keybindings]`) でカスタマイズ可能です：

| 動作 | 設定キー | デフォルト値 | 説明 |
|------|---------|-------------|------|
| 上スクロール | `up` | `["k"]` | ↑キーの代替 |
| 下スクロール | `down` | `["j"]` | ↓キーの代替 |
| 先頭へ移動 | `top` | `["g", "Home"]` | ファイルの最初へ |
| 末尾へ移動 | `bottom` | `["G", "End"]` | ファイルの最後へ |
| 半画面上へ | `half_page_up` | `["ctrl+u"]` | |
| 半画面下へ | `half_page_down` | `["ctrl+d"]` | |

**カスタマイズ例:**

```toml
[keybindings]
# Emacs風キーバインド
up = ["k", "ctrl+p"]
down = ["j", "ctrl+n"]
top = ["alt+<", "Home"]
bottom = ["alt+>", "End"]
```

### 設計上の理由

- **最小限の固定キー**: 基本操作（↑↓）と機能キー（e/a/r/q/?/h）のみ固定
- **柔軟なスクロールキー**: vim/Emacsなど異なるエディタ習慣に対応
- **less/man風**: 既存のページャーツールと同様の操作感
- **カーソルなし**: 編集機能を持たないため、カーソル概念は不要

## TUI画面レイアウト

「一枚の紙」のコンセプトに基づき、最小限の情報のみ表示します。

### 画面構成

```
┌─────────────────────────────────────────────────┐
│ # Today                                         │
│                                                 │
│ - [ ] Buy milk                                  │
│ - [x] Review PR #123 @done(2026-01-18)          │
│ - [ ] Write documentation                       │
│                                                 │
│ ## Notes                                        │ ← メインエリア
│                                                 │
│ - Remember to check email                       │
│                                                 │
├─────────────────────────────────────────────────┤
│ ? help | e edit | a archive | q quit   [15/42] │ ← フッター
└─────────────────────────────────────────────────┘
```

### 各エリアの詳細

#### ヘッダー

**なし**。ファイルを意識させないというコンセプトに基づき、ヘッダーは表示しません。

#### メインエリア

- ファイル内容をそのまま表示（Markdownレンダリングなし）
- スクロール可能
- 行番号は表示しない

#### フッター（1行）

**通常表示:**
```
? help | e edit | a archive | q quit        [15/42]
```

- 左側: 主要なキー操作ヒント
- 右側: スクロール位置 `[現在行/総行数]`

### ステータスメッセージ

フッターに一時的なメッセージを表示します（3秒後に通常表示に戻る）。

**起動時（新規完了タスク検出時）:**
```
3 tasks marked as done                      [1/42]
```
`- [x]`で`@done(日付)`が無いタスクを検出し、自動的に`@done(今日の日付)`を追加した場合に表示。

**アーカイブ実行時:**
```
Archived 3 tasks                            [1/39]
```

**アーカイブ対象がない場合:**
```
No tasks to archive                         [1/42]
```

### ヘルプオーバーレイ

`?` または `h` でヘルプを表示する際は、画面中央にオーバーレイ表示。
カスタマイズされたキーバインドは動的に反映されます。

**デフォルト設定での表示例:**

```
┌────────────── Help ──────────────┐
│                                  │
│  ↑/k      上へスクロール         │
│  ↓/j      下へスクロール         │
│  g/Home   先頭へ移動             │
│  G/End    末尾へ移動             │
│  Ctrl+u   半画面上へ             │
│  Ctrl+d   半画面下へ             │
│                                  │
│  e        エディタ起動           │
│  a        アーカイブ実行         │
│  r        再読み込み             │
│                                  │
│  q        終了                   │
│  ?/h      ヘルプ                 │
│                                  │
│  Press any key to close          │
└──────────────────────────────────┘
```

### 配色とスタイリング

最小限の配色でシンプルさを保ちます。

| 要素 | スタイル |
|------|---------|
| 未完了タスク (`- [ ]`) | 通常表示 |
| 完了タスク (`- [x]`) | グレー/暗色 |
| `@done(日付)` | グレー/暗色 |
| フッター | 反転表示 |
| ヘルプオーバーレイ | ボーダー付き |

## エラー処理

### 基本方針

- 致命的でないエラーは自動的に対処し、ユーザーの手間を省く
- 致命的なエラーはメッセージを表示して終了
- ファイル編集は直接編集（バックアップはGit自動コミットで保護）

### 起動時

| ケース | 対応 |
|--------|------|
| 設定ファイルがない | デフォルト値で動作 |
| working_dirがない | 自動作成 + `git init` |
| tasks.mdがない | 空ファイルを自動作成 |
| archive.mdがない | 初回アーカイブ時に自動作成 |
| gitリポジトリでない | 自動で `git init` |
| tasks.mdが読めない（権限エラー） | エラーメッセージ表示して終了 |
| 設定ファイルの書式エラー | エラーメッセージ表示して終了 |

### 実行時

| ケース | 対応 |
|--------|------|
| エディタが見つからない | エラーメッセージをフッターに表示 |
| エディタが異常終了 | ファイルを再読み込みして続行 |
| archive.mdに書き込めない | エラーメッセージをフッターに表示 |
| ファイルが外部で削除された | エラーメッセージ表示して終了 |

### エラーメッセージ例

**起動時（致命的エラー）:**
```
Error: Cannot read ~/.ttt/tasks.md: permission denied
```

**実行時（フッターに表示）:**
```
Error: Editor not found: vim                [15/42]
```

## Git連携

nbコマンドに倣い、透過的なGit連携を提供します。ユーザーはGit操作を意識することなく、自動的にバージョン履歴が保存されます。

### 自動コミット

以下のタイミングでバックグラウンドで自動コミット:

- エディタ終了後（ファイル変更時）
- アーカイブ実行後
- `@done(日付)` 追加後
- `ttt -t` でタスク追加時

### 初期化

- working_dir作成時に自動で `git init`
- 既存ディレクトリがgitリポジトリでない場合も自動で `git init`

### 設定

```toml
[git]
auto_commit = true  # デフォルト有効、false で無効化可能
```

### 将来機能（v0.2.0以降）

- `ttt sync` コマンド: 手動でリモートに同期
- リモート設定: `remote = "https://github.com/user/tasks.git"`
- 自動同期: `auto_sync = true/false`

## スコープと制約

### MVP（最小限の機能）

v0.1.0で実装する機能です。

- [ ] メインファイルの閲覧（スクロール可能）
- [ ] 完了タスク（`- [x]`）の検出
- [ ] 完了タスクのアーカイブ（`@done(日付)`自動追加）
- [ ] 外部エディタ起動（設定ファイルのテンプレート使用）
- [ ] 基本的なキーバインド（↑↓, e, a, r, q, ?/h）
- [ ] コマンドラインからのタスク追加（`-t`, `--task`）
- [ ] Git自動コミット（透過的なバージョン管理）

### 将来バージョンで検討するもの

v0.2.0以降で検討可能です。ただし慎重に検討します。

- `ttt sync` コマンド（リモートへの手動同期）
- リモート設定と自動同期
- スナップショット機能（今日の状態を保存）
- 別ファイルへのアーカイブ（設定で選択可能）
- シンタックスハイライト
- 簡易統計表示（今日のタスク数など）
- 期限（@due）のサポート

### リソース制約

- 個人開発（メンテナンス負荷を最小に）
- ドキュメントは最小限
  - README.md
  - concept.md（構想・思想）
  - specification.md（この文書）
  - architecture.md（技術選定・アーキテクチャ）
  - usage.md（ユーザーズガイド）
- テストは必要最小限（コア機能のみ）
