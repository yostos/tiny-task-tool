# ttt - アーキテクチャ

Updated: 2026-01-18

## この文書について

この文書は ttt (Tiny Task Tool) の技術選定とアーキテクチャを記述します。
技術選定の過程と意思決定の理由を記録し、将来の参照に備えます。

- 構想・設計思想については [concept.md](concept.md) を参照
- 機能仕様については [specification.md](specification.md) を参照

## 技術選定

### 決定済みの項目

#### プログラミング言語：Go

**決定日**: 2026-01-18

**選定理由**:
- シングルバイナリで配布が容易
- 起動速度が速い（concept.mdの「摩擦の排除」に合致）
- 学習コストが低く、AI駆動開発との相性が良い
- bubbletea（TUIライブラリ）が成熟している

**検討した代替案と不採用理由**:

| 候補 | 不採用理由 |
| ---- | ---------- |
| Rust | 学習コストが高い。所有権・ライフタイムの概念が独特で、AI駆動開発でコンパイルエラー修正時に理解がないと堂々巡りになるリスク。将来的に学習目的で書き換える可能性は残す。 |
| Python | PEP 668によりシステムPythonへの直接インストールが制限され、配布が複雑化。pipx等の追加ステップをユーザーに強いることになる。起動速度も遅め。 |
| Ruby | gem installで配布可能だが、言語としてのモメンタムが下降傾向。AI学習データも今後増えにくく、AI駆動開発を学ぶプラットフォームとしては将来性に懸念。 |
| TypeScript | AI生成精度は高いが、Node.jsランタイムへの依存が必要。シングルバイナリで配布できない点がconcept.mdの「摩擦の排除」に反する。 |

**将来の展望**:
- 学習目的でRustへの書き換えを検討する可能性あり
- その場合、ratatui + crossterm を使用予定

#### 設定ファイル処理：pelletier/go-toml v2

**決定日**: 2026-01-18

**選定理由**:
- TOML 1.0.0 準拠
- 活発にメンテナンスされている
- encoding/json ライクなAPIでGo開発者に馴染みやすい
- Strictモードでタイポ検出が可能
- 2〜5倍のパフォーマンス優位

**検討した代替案と不採用理由**:

| 候補 | 不採用理由 |
| ---- | ---------- |
| BurntSushi/toml | メンテナンスされていない（unsupported）。TOML 0.4止まり。 |
| spf13/viper | 多機能だが重厚。本プロジェクトにはオーバースペック。 |
| knadh/koanf | viperの軽量代替だが、シンプルなTOML読み込みには不要。 |

#### Markdownパーサー：yuin/goldmark

**決定日**: 2026-01-18

**選定理由**:
- 活発にメンテナンスされている（2026-01-06更新）
- CommonMark 0.31.2 準拠
- Hugo（静的サイトジェネレータ）がデフォルト採用、32.2k依存の実績
- タスクリスト拡張をサポート
- 外部依存なし（標準ライブラリのみ）
- カスタムAST、パーサー、レンダラーによる高い拡張性

**検討した代替案と不採用理由**:

| 候補 | 不採用理由 |
| ---- | ---------- |
| russross/blackfriday | 2020年11月以降更新なし。メンテナンス停止状態。 |
| gomarkdown/markdown | パフォーマンスが大幅に劣る（約20倍遅い）。更新頻度も低い。 |
| 正規表現で自前実装 | 見出し・リンク等の色分け対応でパターンが複雑化し、保守性が低下する。 |

#### CLI引数解析：spf13/pflag

**決定日**: 2026-01-18

**選定理由**:
- 活発にメンテナンスされている（2025-09-02更新、v1.0.10）
- 348kプロジェクトが依存する実績
- POSIX準拠の引数解析
- 短縮形（`-t`）と長形式（`--task`）を1行で定義可能
- Go標準のflagパッケージと互換性あり

**検討した代替案と不採用理由**:

| 候補 | 不採用理由 |
| ---- | ---------- |
| flag（標準） | 短縮形と長形式の両方を定義するには2回定義が必要で冗長。 |
| spf13/cobra | サブコマンド機能など、本プロジェクトにはオーバースペック。 |
| urfave/cli | 機能は十分だが、pflagよりやや重厚。 |
| alecthomas/kong | 知名度が低く、採用実績がpflagより少ない。 |

#### TUIフレームワーク：charmbracelet/bubbletea

**決定日**: 2026-01-18

**選定理由**:
- 圧倒的な採用実績（38.4kスター、17.6k依存プロジェクト）
- Charm社による継続的なメンテナンス（2025-09-17更新、v1.3.10）
- Elmアーキテクチャ採用で状態管理が明確、コードが整理しやすい
- lipgloss（スタイリング）、bubbles（UIコンポーネント）との連携
- 外部エディタ起動・復帰が容易（exec.Commandとの連携が設計済み）
- AI駆動開発との相性：パターンが明確でAI生成コードがレビューしやすい

**検討した代替案と不採用理由**:

| 候補 | 不採用理由 |
| ---- | ---------- |
| rivo/tview | ウィジェットベースでやや重厚。tttのシンプルな要件にはオーバースペック。 |
| gdamore/tcell | 低レベルAPIのため自前実装が多くなり、開発コスト増。 |

#### 静的解析：golangci-lint

**決定日**: 2026-01-18

**選定理由**:
- Go界隈のデファクトスタンダード
- 100+のリンターを統合（staticcheck、revive、go vet、errcheck等）
- 高速実行（並列実行、キャッシュ機能）
- `.golangci.yml` で一括設定管理
- GitHub Actions公式アクションあり

**検討した代替案と不採用理由**:

| 候補 | 不採用理由 |
| ---- | ---------- |
| revive単体 | スタイルチェックのみ。golangci-lint経由で使用可能。 |
| staticcheck単体 | 高品質だが単体では機能限定。golangci-lint経由で使用可能。 |
| go vet単体 | チェック項目が少ない。golangci-lintに含まれる。 |

#### テスト：testing + testify

**決定日**: 2026-01-18

**選定理由**:
- Go標準のtestingパッケージをベースに、testifyでアサーションを簡潔に
- `assert.Equal`等で可読性向上
- モック機能（testify/mock）も利用可能
- Go界隈で広く採用されている組み合わせ

**検討した代替案と不採用理由**:

| 候補 | 不採用理由 |
| ---- | ---------- |
| testing のみ | アサーションが冗長（`if got != want` スタイル）。TDDには非効率。 |
| ginkgo + gomega | BDDスタイルは学習コスト高く、小規模プロジェクトにはオーバースペック。 |

**テスト自動化：**
- 開発時：手動（`go test ./...`）
- PR時：GitHub Actionsで自動実行（テスト + golangci-lint）

### 検討中の項目

（現時点ではなし）

## 技術的制約

### 言語

- Go（バージョンは最新安定版を使用）

### TUIライブラリ

- charmbracelet/bubbletea + lipgloss + bubbles

### 対象環境

- 対象OS：Linux、macOS（Windowsは優先度低）
- 最小サポートターミナル：80x24

## Gitブランチ戦略

GitHub Flow を採用します。

```
main (常にリリース可能)
  ├── feature/xxx    # 機能追加
  ├── fix/xxx        # バグ修正
  └── docs/xxx       # ドキュメント更新
```

**ルール：**
- `main` は常にリリース可能な状態を維持
- 作業は必ずブランチを切って行う
- 完了したらmainにsquash merge
- バージョンはタグで管理（`v0.1.0` 等）

**選定理由：**
- 個人開発でシンプルさを重視
- Git Flowは複雑すぎる（develop/release/hotfix等が不要）
- Trunk Based Developmentも可能だが、機能単位での管理がしやすいGitHub Flowを採用

## アーキテクチャ

### ディレクトリ構成

```
ttt/
├── main.go                 # エントリーポイント
├── go.mod                  # Goモジュール定義
├── go.sum                  # 依存関係ハッシュ
├── .golangci.yml           # linter設定
├── docs/                   # ドキュメント
│   ├── concept.md
│   ├── specification.md
│   ├── architecture.md
│   └── TODO.md
└── internal/               # 内部パッケージ
    ├── cli/                # CLI引数解析
    │   ├── cli.go
    │   └── cli_test.go
    ├── config/             # 設定ファイル読み込み
    │   ├── config.go
    │   └── config_test.go
    ├── task/               # タスク操作（パース、追加、アーカイブ）
    └── tui/                # TUI（bubbletea）
```

### モジュール構成

| パッケージ | 責務 |
|-----------|------|
| `main` | エントリーポイント、初期化、モード分岐 |
| `internal/cli` | CLI引数解析（pflag使用） |
| `internal/config` | 設定ファイル読み込み、デフォルト値管理 |
| `internal/task` | タスクファイルの読み書き、アーカイブ処理 |
| `internal/tui` | TUI表示、キー入力処理（bubbletea） |

### データフロー

```
起動
  │
  ├─ CLI引数解析
  │    │
  │    ├─ --help/--version → 表示して終了
  │    │
  │    └─ --task → タスク追加 → git commit → 終了
  │
  └─ TUIモード
       │
       ├─ 設定読み込み
       ├─ working_dir確保（自動作成、git init）
       ├─ tasks.md読み込み
       ├─ @done自動追加（新規完了タスク検出時）
       ├─ 自動アーカイブ（archive.auto=true時）
       │
       └─ TUIループ
            ├─ 表示
            ├─ キー入力待ち
            │    ├─ e → エディタ起動 → 再読み込み → git commit
            │    ├─ a → アーカイブ実行 → git commit
            │    ├─ r → 再読み込み
            │    └─ q → 終了
            └─ 状態更新
```
